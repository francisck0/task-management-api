name: CI - Build and Test

# ============================================================================
# TRIGGERS - Cuándo se ejecuta este workflow
# ============================================================================
on:
  # Se ejecuta en cada push a cualquier rama
  push:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'hotfix/**'
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'

  # Se ejecuta en cada Pull Request
  pull_request:
    branches:
      - main
      - develop
    paths-ignore:
      - '**.md'
      - 'docs/**'

  # Permite ejecución manual desde GitHub UI
  workflow_dispatch:

# ============================================================================
# PERMISOS
# ============================================================================
permissions:
  contents: read
  checks: write
  pull-requests: write

# ============================================================================
# VARIABLES DE ENTORNO GLOBALES
# ============================================================================
env:
  JAVA_VERSION: '21'
  GRADLE_OPTS: '-Dorg.gradle.daemon=false -Dorg.gradle.parallel=true'

# ============================================================================
# JOBS
# ============================================================================
jobs:
  # ==========================================================================
  # JOB 1: BUILD Y TEST
  # ==========================================================================
  build-and-test:
    name: Build and Test (Java ${{ matrix.java }})
    runs-on: ubuntu-latest

    # Estrategia de matriz para probar en múltiples versiones de Java
    strategy:
      matrix:
        java: ['21']
        # Descomentar para probar en múltiples versiones:
        # java: ['17', '21']
      fail-fast: false

    # Servicios necesarios para los tests (PostgreSQL)
    services:
      postgres:
        image: postgres:18-alpine
        env:
          POSTGRES_DB: taskmanagement_db_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      # ======================================================================
      # CHECKOUT - Obtener código del repositorio
      # ======================================================================
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch completo para SonarQube

      # ======================================================================
      # JAVA SETUP - Configurar JDK
      # ======================================================================
      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java }}
          distribution: 'temurin'
          cache: 'gradle'

      # ======================================================================
      # GRADLE - Dar permisos de ejecución
      # ======================================================================
      - name: Make gradlew executable
        run: chmod +x ./gradlew

      # ======================================================================
      # GRADLE - Validar wrapper
      # ======================================================================
      - name: Validate Gradle wrapper
        uses: gradle/wrapper-validation-action@v2

      # ======================================================================
      # BUILD - Compilar proyecto
      # ======================================================================
      - name: Build with Gradle
        run: ./gradlew build -x test --no-daemon --stacktrace

      # ======================================================================
      # TESTS - Ejecutar tests unitarios e integración
      # ======================================================================
      - name: Run tests
        env:
          SPRING_PROFILES_ACTIVE: test
          DATABASE_URL: jdbc:postgresql://localhost:5432/taskmanagement_db_test
          DATABASE_USERNAME: postgres
          DATABASE_PASSWORD: postgres
        run: ./gradlew test --no-daemon --stacktrace

      # ======================================================================
      # COVERAGE - Generar reporte de cobertura
      # ======================================================================
      - name: Generate test coverage report
        if: always()
        run: ./gradlew jacocoTestReport --no-daemon

      # ======================================================================
      # PUBLISH - Publicar resultados de tests
      # ======================================================================
      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: |
            build/test-results/**/*.xml
          check_name: Test Results (Java ${{ matrix.java }})

      # ======================================================================
      # ARCHIVE - Guardar reportes
      # ======================================================================
      - name: Archive test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports-java-${{ matrix.java }}
          path: |
            build/reports/tests/
            build/test-results/
          retention-days: 30

      # ======================================================================
      # ARCHIVE - Guardar coverage reports
      # ======================================================================
      - name: Archive coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-reports-java-${{ matrix.java }}
          path: build/reports/jacoco/
          retention-days: 30

      # ======================================================================
      # ARTIFACT - Guardar JAR compilado
      # ======================================================================
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: task-management-api-${{ matrix.java }}
          path: build/libs/*.jar
          retention-days: 7

  # ==========================================================================
  # JOB 2: CODE QUALITY CHECKS
  # ==========================================================================
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      # Checkstyle - Verificar estilo de código
      - name: Run Checkstyle
        run: ./gradlew checkstyleMain checkstyleTest || true
        continue-on-error: true

      # SpotBugs - Detectar bugs potenciales
      - name: Run SpotBugs
        run: ./gradlew spotbugsMain || true
        continue-on-error: true

      # PMD - Análisis estático de código
      - name: Run PMD
        run: ./gradlew pmdMain || true
        continue-on-error: true

      - name: Archive quality reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: quality-reports
          path: |
            build/reports/checkstyle/
            build/reports/spotbugs/
            build/reports/pmd/
          retention-days: 30

  # ==========================================================================
  # JOB 3: DEPENDENCY CHECK
  # ==========================================================================
  dependency-check:
    name: Dependency Security Check
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      # OWASP Dependency Check
      - name: Run OWASP Dependency Check
        run: ./gradlew dependencyCheckAnalyze || true
        continue-on-error: true

      - name: Upload dependency check report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-check-report
          path: build/reports/dependency-check-report.html
          retention-days: 30

  # ==========================================================================
  # JOB 4: BUILD SUCCESS NOTIFICATION
  # ==========================================================================
  build-status:
    name: Build Status
    runs-on: ubuntu-latest
    needs: [build-and-test, code-quality, dependency-check]
    if: always()

    steps:
      - name: Check build status
        run: |
          if [[ "${{ needs.build-and-test.result }}" == "success" ]]; then
            echo "✅ Build and tests passed successfully!"
            exit 0
          else
            echo "❌ Build or tests failed!"
            exit 1
          fi

      # Opcional: Notificación a Slack/Discord
      # - name: Notify Slack
      #   if: failure()
      #   uses: 8398a7/action-slack@v3
      #   with:
      #     status: ${{ job.status }}
      #     text: 'CI Build failed'
      #     webhook_url: ${{ secrets.SLACK_WEBHOOK }}
